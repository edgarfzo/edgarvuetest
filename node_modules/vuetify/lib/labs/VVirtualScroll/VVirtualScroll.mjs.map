{"version":3,"file":"VVirtualScroll.mjs","names":["VVirtualScrollItem","makeDimensionProps","useDimension","computed","ref","convertToUnit","createRange","genericComponent","getPropertyFromItem","useRender","UP","DOWN","VVirtualScroll","name","props","items","type","Array","default","itemKey","String","itemHeight","Number","visibleItems","setup","slots","first","baseItemHeight","get","parseInt","value","set","val","rootEl","ids","Map","map","item","index","sizes","length","handleItemResize","height","calculateOffset","slice","reduce","curr","calculateMidPointIndex","scrollTop","start","end","middle","Math","floor","middleOffset","lastScrollTop","handleScroll","direction","midPointIndex","buffer","round","max","min","last","computedItems","paddingTop","paddingBottom","dimensionStyles"],"sources":["../../../src/labs/VVirtualScroll/VVirtualScroll.tsx"],"sourcesContent":["// Styles\nimport './VVirtualScroll.sass'\n\n// Components\nimport { VVirtualScrollItem } from './VVirtualScrollItem'\n\n// Composables\nimport { makeDimensionProps, useDimension } from '@/composables/dimensions'\n\n// Utilities\nimport { computed, ref } from 'vue'\nimport {\n  convertToUnit,\n  createRange,\n  genericComponent,\n  getPropertyFromItem,\n  useRender,\n} from '@/util'\n\n// Types\nimport type { MakeSlots, SlotsToProps } from '@/util'\n\nconst UP = -1\nconst DOWN = 1\n\nexport interface VVirtualScrollSlot<T> {\n  item: T\n  index: number\n}\n\nexport const VVirtualScroll = genericComponent<new <T>() => {\n  $props: {\n    items: readonly T[]\n  } & SlotsToProps<\n    MakeSlots<{\n      default: [VVirtualScrollSlot<T>]\n    }>\n  >\n}>()({\n  name: 'VVirtualScroll',\n\n  props: {\n    items: {\n      type: Array,\n      default: () => ([]),\n    },\n    itemKey: {\n      type: String,\n      default: 'value',\n    },\n    itemHeight: [Number, String],\n    visibleItems: {\n      type: [Number, String],\n      default: 30,\n    },\n\n    ...makeDimensionProps(),\n  },\n\n  setup (props, { slots }) {\n    const first = ref(0)\n    const baseItemHeight = ref(props.itemHeight)\n    const itemHeight = computed({\n      get: () => parseInt(baseItemHeight.value ?? 0, 10),\n      set (val) {\n        baseItemHeight.value = val\n      },\n    })\n    const visibleItems = computed(() => parseInt(props.visibleItems, 10))\n    const rootEl = ref<HTMLDivElement>()\n\n    const ids = new Map<unknown, number>(props.items.map((item, index) => [getPropertyFromItem(item, props.itemKey, item), index]))\n    const sizes = createRange(props.items.length).map(() => itemHeight.value)\n\n    function handleItemResize (item: unknown, height: number) {\n      const index = ids.get(getPropertyFromItem(item, props.itemKey, item))\n\n      if (!index) return\n\n      sizes[index] = height\n\n      if (!itemHeight.value) itemHeight.value = height\n    }\n\n    function calculateOffset (index: number) {\n      return sizes.slice(0, index).reduce((curr, value) => curr + (value || itemHeight.value), 0)\n    }\n\n    function calculateMidPointIndex (scrollTop: number) {\n      let start = 0\n      let end = props.items.length\n\n      while (start <= end) {\n        const middle = start + Math.floor((end - start) / 2)\n        const middleOffset = calculateOffset(middle)\n\n        if (middleOffset === scrollTop) {\n          return middle\n        } else if (middleOffset < scrollTop) {\n          start = middle + 1\n        } else if (middleOffset > scrollTop) {\n          end = middle - 1\n        }\n      }\n\n      return start\n    }\n\n    let lastScrollTop = 0\n    function handleScroll () {\n      if (!rootEl.value) return\n\n      const scrollTop = rootEl.value.scrollTop\n      const direction = scrollTop < lastScrollTop ? UP : DOWN\n\n      const midPointIndex = calculateMidPointIndex(scrollTop)\n\n      const buffer = Math.round(visibleItems.value / 3)\n      if (direction === UP && midPointIndex <= first.value) {\n        first.value = Math.max(midPointIndex - buffer, 0)\n      } else if (direction === DOWN && midPointIndex >= first.value + (buffer * 2)) {\n        first.value = Math.min(Math.max(0, midPointIndex - buffer), props.items.length - visibleItems.value)\n      }\n\n      lastScrollTop = rootEl.value.scrollTop\n    }\n\n    const last = computed(() => Math.min(props.items.length, first.value + visibleItems.value))\n    const computedItems = computed(() => props.items.slice(first.value, last.value))\n    const paddingTop = computed(() => calculateOffset(first.value))\n    const paddingBottom = computed(() => calculateOffset(props.items.length) - calculateOffset(last.value))\n\n    const { dimensionStyles } = useDimension(props)\n\n    useRender(() => (\n      <div\n        ref={ rootEl }\n        class=\"v-virtual-scroll\"\n        onScroll={ handleScroll }\n        style={ dimensionStyles.value }\n      >\n        <div\n          class=\"v-virtual-scroll__container\"\n          style={{\n            paddingTop: convertToUnit(paddingTop.value),\n            paddingBottom: convertToUnit(paddingBottom.value),\n          }}\n        >\n          { computedItems.value.map((item, index) => (\n            <VVirtualScrollItem\n              key={ index }\n              dynamicHeight={ !props.itemHeight }\n              onUpdate:height={ height => handleItemResize(item, height) }\n            >\n              { slots.default?.({ item, index: index + first.value }) }\n            </VVirtualScrollItem>\n          )) }\n        </div>\n      </div>\n    ))\n  },\n})\n\nexport type VVirtualScroll = InstanceType<typeof VVirtualScroll>\n"],"mappings":";AAAA;AACA;;AAEA;AAAA,SACSA,kBAAkB,oCAE3B;AAAA,SACSC,kBAAkB,EAAEC,YAAY,4CAEzC;AACA,SAASC,QAAQ,EAAEC,GAAG,QAAQ,KAAK;AAAA,SAEjCC,aAAa,EACbC,WAAW,EACXC,gBAAgB,EAChBC,mBAAmB,EACnBC,SAAS,gCAGX;AAGA,MAAMC,EAAE,GAAG,CAAC,CAAC;AACb,MAAMC,IAAI,GAAG,CAAC;AAOd,OAAO,MAAMC,cAAc,GAAGL,gBAAgB,EAQ1C,CAAC;EACHM,IAAI,EAAE,gBAAgB;EAEtBC,KAAK,EAAE;IACLC,KAAK,EAAE;MACLC,IAAI,EAAEC,KAAK;MACXC,OAAO,EAAE,MAAO;IAClB,CAAC;IACDC,OAAO,EAAE;MACPH,IAAI,EAAEI,MAAM;MACZF,OAAO,EAAE;IACX,CAAC;IACDG,UAAU,EAAE,CAACC,MAAM,EAAEF,MAAM,CAAC;IAC5BG,YAAY,EAAE;MACZP,IAAI,EAAE,CAACM,MAAM,EAAEF,MAAM,CAAC;MACtBF,OAAO,EAAE;IACX,CAAC;IAED,GAAGjB,kBAAkB;EACvB,CAAC;EAEDuB,KAAK,CAAEV,KAAK,QAAa;IAAA,IAAX;MAAEW;IAAM,CAAC;IACrB,MAAMC,KAAK,GAAGtB,GAAG,CAAC,CAAC,CAAC;IACpB,MAAMuB,cAAc,GAAGvB,GAAG,CAACU,KAAK,CAACO,UAAU,CAAC;IAC5C,MAAMA,UAAU,GAAGlB,QAAQ,CAAC;MAC1ByB,GAAG,EAAE,MAAMC,QAAQ,CAACF,cAAc,CAACG,KAAK,IAAI,CAAC,EAAE,EAAE,CAAC;MAClDC,GAAG,CAAEC,GAAG,EAAE;QACRL,cAAc,CAACG,KAAK,GAAGE,GAAG;MAC5B;IACF,CAAC,CAAC;IACF,MAAMT,YAAY,GAAGpB,QAAQ,CAAC,MAAM0B,QAAQ,CAACf,KAAK,CAACS,YAAY,EAAE,EAAE,CAAC,CAAC;IACrE,MAAMU,MAAM,GAAG7B,GAAG,EAAkB;IAEpC,MAAM8B,GAAG,GAAG,IAAIC,GAAG,CAAkBrB,KAAK,CAACC,KAAK,CAACqB,GAAG,CAAC,CAACC,IAAI,EAAEC,KAAK,KAAK,CAAC9B,mBAAmB,CAAC6B,IAAI,EAAEvB,KAAK,CAACK,OAAO,EAAEkB,IAAI,CAAC,EAAEC,KAAK,CAAC,CAAC,CAAC;IAC/H,MAAMC,KAAK,GAAGjC,WAAW,CAACQ,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC,CAACJ,GAAG,CAAC,MAAMf,UAAU,CAACS,KAAK,CAAC;IAEzE,SAASW,gBAAgB,CAAEJ,IAAa,EAAEK,MAAc,EAAE;MACxD,MAAMJ,KAAK,GAAGJ,GAAG,CAACN,GAAG,CAACpB,mBAAmB,CAAC6B,IAAI,EAAEvB,KAAK,CAACK,OAAO,EAAEkB,IAAI,CAAC,CAAC;MAErE,IAAI,CAACC,KAAK,EAAE;MAEZC,KAAK,CAACD,KAAK,CAAC,GAAGI,MAAM;MAErB,IAAI,CAACrB,UAAU,CAACS,KAAK,EAAET,UAAU,CAACS,KAAK,GAAGY,MAAM;IAClD;IAEA,SAASC,eAAe,CAAEL,KAAa,EAAE;MACvC,OAAOC,KAAK,CAACK,KAAK,CAAC,CAAC,EAAEN,KAAK,CAAC,CAACO,MAAM,CAAC,CAACC,IAAI,EAAEhB,KAAK,KAAKgB,IAAI,IAAIhB,KAAK,IAAIT,UAAU,CAACS,KAAK,CAAC,EAAE,CAAC,CAAC;IAC7F;IAEA,SAASiB,sBAAsB,CAAEC,SAAiB,EAAE;MAClD,IAAIC,KAAK,GAAG,CAAC;MACb,IAAIC,GAAG,GAAGpC,KAAK,CAACC,KAAK,CAACyB,MAAM;MAE5B,OAAOS,KAAK,IAAIC,GAAG,EAAE;QACnB,MAAMC,MAAM,GAAGF,KAAK,GAAGG,IAAI,CAACC,KAAK,CAAC,CAACH,GAAG,GAAGD,KAAK,IAAI,CAAC,CAAC;QACpD,MAAMK,YAAY,GAAGX,eAAe,CAACQ,MAAM,CAAC;QAE5C,IAAIG,YAAY,KAAKN,SAAS,EAAE;UAC9B,OAAOG,MAAM;QACf,CAAC,MAAM,IAAIG,YAAY,GAAGN,SAAS,EAAE;UACnCC,KAAK,GAAGE,MAAM,GAAG,CAAC;QACpB,CAAC,MAAM,IAAIG,YAAY,GAAGN,SAAS,EAAE;UACnCE,GAAG,GAAGC,MAAM,GAAG,CAAC;QAClB;MACF;MAEA,OAAOF,KAAK;IACd;IAEA,IAAIM,aAAa,GAAG,CAAC;IACrB,SAASC,YAAY,GAAI;MACvB,IAAI,CAACvB,MAAM,CAACH,KAAK,EAAE;MAEnB,MAAMkB,SAAS,GAAGf,MAAM,CAACH,KAAK,CAACkB,SAAS;MACxC,MAAMS,SAAS,GAAGT,SAAS,GAAGO,aAAa,GAAG7C,EAAE,GAAGC,IAAI;MAEvD,MAAM+C,aAAa,GAAGX,sBAAsB,CAACC,SAAS,CAAC;MAEvD,MAAMW,MAAM,GAAGP,IAAI,CAACQ,KAAK,CAACrC,YAAY,CAACO,KAAK,GAAG,CAAC,CAAC;MACjD,IAAI2B,SAAS,KAAK/C,EAAE,IAAIgD,aAAa,IAAIhC,KAAK,CAACI,KAAK,EAAE;QACpDJ,KAAK,CAACI,KAAK,GAAGsB,IAAI,CAACS,GAAG,CAACH,aAAa,GAAGC,MAAM,EAAE,CAAC,CAAC;MACnD,CAAC,MAAM,IAAIF,SAAS,KAAK9C,IAAI,IAAI+C,aAAa,IAAIhC,KAAK,CAACI,KAAK,GAAI6B,MAAM,GAAG,CAAE,EAAE;QAC5EjC,KAAK,CAACI,KAAK,GAAGsB,IAAI,CAACU,GAAG,CAACV,IAAI,CAACS,GAAG,CAAC,CAAC,EAAEH,aAAa,GAAGC,MAAM,CAAC,EAAE7C,KAAK,CAACC,KAAK,CAACyB,MAAM,GAAGjB,YAAY,CAACO,KAAK,CAAC;MACtG;MAEAyB,aAAa,GAAGtB,MAAM,CAACH,KAAK,CAACkB,SAAS;IACxC;IAEA,MAAMe,IAAI,GAAG5D,QAAQ,CAAC,MAAMiD,IAAI,CAACU,GAAG,CAAChD,KAAK,CAACC,KAAK,CAACyB,MAAM,EAAEd,KAAK,CAACI,KAAK,GAAGP,YAAY,CAACO,KAAK,CAAC,CAAC;IAC3F,MAAMkC,aAAa,GAAG7D,QAAQ,CAAC,MAAMW,KAAK,CAACC,KAAK,CAAC6B,KAAK,CAAClB,KAAK,CAACI,KAAK,EAAEiC,IAAI,CAACjC,KAAK,CAAC,CAAC;IAChF,MAAMmC,UAAU,GAAG9D,QAAQ,CAAC,MAAMwC,eAAe,CAACjB,KAAK,CAACI,KAAK,CAAC,CAAC;IAC/D,MAAMoC,aAAa,GAAG/D,QAAQ,CAAC,MAAMwC,eAAe,CAAC7B,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC,GAAGG,eAAe,CAACoB,IAAI,CAACjC,KAAK,CAAC,CAAC;IAEvG,MAAM;MAAEqC;IAAgB,CAAC,GAAGjE,YAAY,CAACY,KAAK,CAAC;IAE/CL,SAAS,CAAC;MAAA,OAEAwB,MAAM;MAAA,SACN,kBAAkB;MAAA,YACbuB,YAAY;MAAA,SACfW,eAAe,CAACrC;IAAK;MAAA,SAGrB,6BAA6B;MAAA,SAC5B;QACLmC,UAAU,EAAE5D,aAAa,CAAC4D,UAAU,CAACnC,KAAK,CAAC;QAC3CoC,aAAa,EAAE7D,aAAa,CAAC6D,aAAa,CAACpC,KAAK;MAClD;IAAC,IAECkC,aAAa,CAAClC,KAAK,CAACM,GAAG,CAAC,CAACC,IAAI,EAAEC,KAAK;MAAA;MAAA;QAAA,OAE5BA,KAAK;QAAA,iBACK,CAACxB,KAAK,CAACO,UAAU;QAAA,mBACfqB,MAAM,IAAID,gBAAgB,CAACJ,IAAI,EAAEK,MAAM;MAAC;QAAA,kCAExDjB,KAAK,CAACP,OAAO,qBAAb,oBAAAO,KAAK,EAAW;UAAEY,IAAI;UAAEC,KAAK,EAAEA,KAAK,GAAGZ,KAAK,CAACI;QAAM,CAAC,CAAC;MAAA;IAAA,CAE1D,CAAC,IAGP,CAAC;EACJ;AACF,CAAC,CAAC"}